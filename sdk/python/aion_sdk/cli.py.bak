#!/usr/bin/env python3
"""
AION Story Engine CLI - å¢å¼ºç‰ˆ

å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºä¸ AION Story Engine äº¤äº’

å®‰è£…:
    pip install -e .

ä½¿ç”¨:
    aion --help
    aion session create "My Story"
    aion universe list
    aion asset search "fire"
"""

import argparse
import sys
from typing import Optional

from aion_sdk import AionClient

# ç‰ˆæœ¬ä¿¡æ¯
VERSION = "6.0.0"


class Colors:
    """ç»ˆç«¯é¢œè‰²å¸¸é‡"""
    BLUE = "\033[94m"
    GREEN = "\033[92m"
    YELLOW = "\033[93m"
    RED = "\033[91m"
    PURPLE = "\033[95m"
    CYAN = "\033[96m"
    WHITE = "\033[97m"
    BOLD = "\033[1m"
    UNDERLINE = "\033[4m"
    END = "\033[0m"


def colorize(text: str, color: str) -> str:
    """ä¸ºæ–‡æœ¬æ·»åŠ é¢œè‰²"""
    return f"{color}{text}{Colors.END}"


def print_header(title: str):
    """æ‰“å°æ ‡é¢˜"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'=' * 60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{title.center(60)}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'=' * 60}{Colors.END}\n")


def print_success(message: str):
    """æ‰“å°æˆåŠŸæ¶ˆæ¯"""
    print(f"{Colors.GREEN}âœ… {message}{Colors.END}")


def print_error(message: str):
    """æ‰“å°é”™è¯¯æ¶ˆæ¯"""
    print(f"{Colors.RED}âŒ {message}{Colors.END}")


def print_info(message: str):
    """æ‰“å°ä¿¡æ¯æ¶ˆæ¯"""
    print(f"{Colors.BLUE}â„¹ï¸  {message}{Colors.END}")


def print_warning(message: str):
    """æ‰“å°è­¦å‘Šæ¶ˆæ¯"""
    print(f"{Colors.YELLOW}âš ï¸  {message}{Colors.END}")


def get_client(api_key: str, base_url: str) -> Optional[AionClient]:
    """è·å– API å®¢æˆ·ç«¯"""
    try:
        client = AionClient(api_key=api_key, base_url=base_url)
        # æµ‹è¯•è¿æ¥
        client.health_check()
        return client
    except Exception as e:
        print_error(f"æ— æ³•è¿æ¥åˆ° API: {e}")
        print_info(f"è¯·æ£€æŸ¥ API åœ°å€: {base_url}")
        print_info(f"æˆ–è€…è®¾ç½®æ­£ç¡®çš„ API Key: --api-key")
        return None


def cmd_health(args):
    """å¥åº·æ£€æŸ¥å‘½ä»¤"""
    print_header("å¥åº·æ£€æŸ¥")

    client = get_client(args.api_key, args.base_url)
    if not client:
        return

    try:
        health = client.health_check()
        print_success(f"æœåŠ¡çŠ¶æ€: {health['status']}")
        print_info(f"ç‰ˆæœ¬: {health['version']}")
        print_info(f"æœåŠ¡: {health['service']}")
    except Exception as e:
        print_error(f"å¥åº·æ£€æŸ¥å¤±è´¥: {e}")


def cmd_session_create(args):
    """åˆ›å»ºä¼šè¯å‘½ä»¤"""
    print_header("åˆ›å»ºæ•…äº‹ä¼šè¯")

    client = get_client(args.api_key, args.base_url)
    if not client:
        return

    try:
        session = client.create_session(name=args.name, owner_id=args.owner)
        print_success(f"ä¼šè¯åˆ›å»ºæˆåŠŸ!")
        print_info(f"ä¼šè¯ ID: {session.session_id}")
        print_info(f"åç§°: {session.name}")
        print_info(f"çŠ¶æ€: {session.status}")
        if args.verbose:
            print_info(f"æ¶ˆæ¯: {session.message}")
    except Exception as e:
        print_error(f"åˆ›å»ºä¼šè¯å¤±è´¥: {e}")


def cmd_session_list(args):
    """åˆ—å‡ºä¼šè¯å‘½ä»¤"""
    print_header("æ•…äº‹ä¼šè¯åˆ—è¡¨")

    client = get_client(args.api_key, args.base_url)
    if not client:
        return

    try:
        sessions = client.list_sessions(skip=args.skip, limit=args.limit)
        print_info(f"æ‰¾åˆ° {len(sessions)} ä¸ªä¼šè¯")

        for session in sessions:
            status_color = Colors.GREEN if session.status == "active" else Colors.YELLOW
            print(f"\n{Colors.BOLD}{session.name}{Colors.END}")
            print(f"  ID: {session.session_id}")
            print(f"  çŠ¶æ€: {status_color}{session.status}{Colors.END}")

    except Exception as e:
        print_error(f"åˆ—å‡ºä¼šè¯å¤±è´¥: {e}")


def cmd_universe_list(args):
    """åˆ—å‡ºå®‡å®™å‘½ä»¤"""
    print_header("å¤šå…ƒå®‡å®™åˆ—è¡¨")

    client = get_client(args.api_key, args.base_url)
    if not client:
        return

    try:
        universes = client.list_universes(skip=args.skip, limit=args.limit)
        print_info(f"æ‰¾åˆ° {len(universes)} ä¸ªå®‡å®™")

        for universe in universes:
            theme_color = Colors.PURPLE if universe.theme == "fantasy" else Colors.CYAN
            visibility = "ğŸŒ" if universe.is_public else "ğŸ”’"

            print(f"\n{visibility} {Colors.BOLD}{universe.name}{Colors.END}")
            print(f"  ä¸»é¢˜: {theme_color}{universe.theme}{Colors.END}")
            print(f"  åˆ›å»ºè€…: {universe.creator_id}")
            print(f"  æ ‡ç­¾: {', '.join(universe.tags[:3])}")

    except Exception as e:
        print_error(f"åˆ—å‡ºå®‡å®™å¤±è´¥: {e}")


def cmd_universe_create(args):
    """åˆ›å»ºå®‡å®™å‘½ä»¤"""
    print_header("åˆ›å»ºå¤šå…ƒå®‡å®™")

    client = get_client(args.api_key, args.base_url)
    if not client:
        return

    # å¤„ç†æ ‡ç­¾
    tags = args.tags.split(",") if args.tags else []

    # å¤„ç†ç‰©ç†è§„åˆ™
    physics_rules = {}
    if args.gravity:
        physics_rules["gravity"] = args.gravity

    try:
        universe = client.create_universe(
            name=args.name,
            creator_id=args.creator,
            description=args.description,
            physics_rules=physics_rules,
            theme=args.theme,
            tags=tags,
            is_public=not args.private
        )
        print_success(f"å®‡å®™åˆ›å»ºæˆåŠŸ!")
        print_info(f"å®‡å®™ ID: {universe.universe_id}")
        print_info(f"åç§°: {universe.name}")
        print_info(f"ä¸»é¢˜: {universe.theme}")
        print_info(f"æ ‡ç­¾: {', '.join(universe.tags)}")
    except Exception as e:
        print_error(f"åˆ›å»ºå®‡å®™å¤±è´¥: {e}")


def cmd_asset_list(args):
    """åˆ—å‡ºèµ„äº§å‘½ä»¤"""
    print_header("åˆ›ä½œèµ„äº§åˆ—è¡¨")

    client = get_client(args.api_key, args.base_url)
    if not client:
        return

    try:
        assets = client.list_assets(skip=args.skip, limit=args.limit)
        print_info(f"æ‰¾åˆ° {len(assets)} ä¸ªèµ„äº§")

        for asset in assets:
            price = "å…è´¹" if asset.price == 0 else f"${asset.price:.2f}"
            rating = f"â­ {asset.rating:.1f}" if asset.rating else "æ— è¯„åˆ†"
            downloads = f"â¬‡ï¸ {asset.downloads}" if asset.downloads else ""

            print(f"\n{Colors.BOLD}{asset.name}{Colors.END}")
            print(f"  ç±»å‹: {asset.type}")
            print(f"  ä»·æ ¼: {price}")
            print(f"  åˆ›å»ºè€…: {asset.creator or 'æœªçŸ¥'}")
            print(f"  {rating} {downloads}")

    except Exception as e:
        print_error(f"åˆ—å‡ºèµ„äº§å¤±è´¥: {e}")


def cmd_marketplace_stats(args):
    """å¸‚åœºç»Ÿè®¡å‘½ä»¤"""
    print_header("åˆ›ä½œè€…å¸‚åœºç»Ÿè®¡")

    client = get_client(args.api_key, args.base_url)
    if not client:
        return

    try:
        stats = client.get_marketplace_stats()
        print_success("å¸‚åœºæ•°æ®ç»Ÿè®¡")
        print_info(f"æ€»èµ„äº§æ•°: {stats['total_listings']}")
        print_info(f"æ€»äº¤æ˜“æ•°: {stats['total_transactions']}")
        print_info(f"æ€»æ”¶å…¥: ${stats['total_revenue']:,.2f}")
    except Exception as e:
        print_error(f"è·å–å¸‚åœºç»Ÿè®¡å¤±è´¥: {e}")


def cmd_proposal_list(args):
    """åˆ—å‡ºææ¡ˆå‘½ä»¤"""
    print_header("æ²»ç†ææ¡ˆåˆ—è¡¨")

    client = get_client(args.api_key, args.base_url)
    if not client:
        return

    try:
        proposals = client.list_proposals(skip=args.skip, limit=args.limit, status=args.status)
        print_info(f"æ‰¾åˆ° {len(proposals)} ä¸ªææ¡ˆ")

        for proposal in proposals:
            status_color = Colors.GREEN if proposal.status == "active" else Colors.YELLOW

            print(f"\n{Colors.BOLD}{proposal.title}{Colors.END}")
            print(f"  ç±»å‹: {proposal.proposal_type}")
            print(f"  çŠ¶æ€: {status_color}{proposal.status}{Colors.END}")
            print(f"  åˆ›å»ºè€…: {proposal.proposer_id}")
            print(f"  æŠ•ç¥¨: âœ… {proposal.votes_for} / âŒ {proposal.votes_against} / ğŸ¤ {proposal.votes_abstain}")

    except Exception as e:
        print_error(f"åˆ—å‡ºææ¡ˆå¤±è´¥: {e}")


def create_parser():
    """åˆ›å»ºå‘½ä»¤è¡Œè§£æå™¨"""
    parser = argparse.ArgumentParser(
        prog="aion",
        description="AION Story Engine CLI",
        epilog="""
ç¤ºä¾‹:
  aion --api-key your_key session create "My Story"
  aion universe list --limit 10
  aion asset search fire

ç¯å¢ƒå˜é‡:
  AION_API_KEY: API å¯†é’¥
  AION_API_URL: API åŸºç¡€ URL (é»˜è®¤: http://localhost:8000/api/v1)
        """,
        formatter_class=argparse.RawDescriptionHelpFormatter,
    )

    # å…¨å±€å‚æ•°
    parser.add_argument(
        "--api-key",
        type=str,
        default="test_api_key",
        help="API å¯†é’¥ (é»˜è®¤: test_api_key)"
    )
    parser.add_argument(
        "--base-url",
        type=str,
        default="http://localhost:8000/api/v1",
        help="API åŸºç¡€ URL"
    )
    parser.add_argument(
        "--version",
        action="version",
        version=f"%(prog)s {VERSION}"
    )
    parser.add_argument(
        "-v", "--verbose",
        action="store_true",
        help="è¯¦ç»†è¾“å‡º"
    )

    # å­å‘½ä»¤
    subparsers = parser.add_subparsers(dest="command", help="å¯ç”¨å‘½ä»¤")

    # å¥åº·æ£€æŸ¥
    subparsers.add_parser("health", help="æ‰§è¡Œå¥åº·æ£€æŸ¥")

    # ä¼šè¯ç®¡ç†
    session_parser = subparsers.add_parser("session", help="ä¼šè¯ç®¡ç†")
    session_subparsers = session_parser.add_subparsers(dest="action")

    create = session_subparsers.add_parser("create", help="åˆ›å»ºä¼šè¯")
    create.add_argument("name", help="ä¼šè¯åç§°")
    create.add_argument("--owner", help="æ‰€æœ‰è€… ID")
    create.set_defaults(func=cmd_session_create)

    list_sessions = session_subparsers.add_parser("list", help="åˆ—å‡ºä¼šè¯")
    list_sessions.add_argument("--skip", type=int, default=0, help="è·³è¿‡çš„è®°å½•æ•°")
    list_sessions.add_argument("--limit", type=int, default=100, help="è¿”å›çš„æœ€å¤§è®°å½•æ•°")
    list_sessions.set_defaults(func=cmd_session_list)

    # å®‡å®™ç®¡ç†
    universe_parser = subparsers.add_parser("universe", help="å®‡å®™ç®¡ç†")
    universe_subparsers = universe_parser.add_subparsers(dest="action")

    list_universe = universe_subparsers.add_parser("list", help="åˆ—å‡ºå®‡å®™")
    list_universe.add_argument("--skip", type=int, default=0, help="è·³è¿‡çš„è®°å½•æ•°")
    list_universe.add_argument("--limit", type=int, default=100, help="è¿”å›çš„æœ€å¤§è®°å½•æ•°")
    list_universe.set_defaults(func=cmd_universe_list)

    create_universe = universe_subparsers.add_parser("create", help="åˆ›å»ºå®‡å®™")
    create_universe.add_argument("name", help="å®‡å®™åç§°")
    create_universe.add_argument("creator", help="åˆ›å»ºè€… ID")
    create_universe.add_argument("description", help="å®‡å®™æè¿°")
    create_universe.add_argument("theme", help="å®‡å®™ä¸»é¢˜")
    create_universe.add_argument("--tags", help="æ ‡ç­¾åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰")
    create_universe.add_argument("--gravity", type=float, help="é‡åŠ›åŠ é€Ÿåº¦")
    create_universe.add_argument("--private", action="store_true", help="è®¾ä¸ºç§æœ‰å®‡å®™")
    create_universe.set_defaults(func=cmd_universe_create)

    # èµ„äº§ç®¡ç†
    asset_parser = subparsers.add_parser("asset", help="èµ„äº§ç®¡ç†")
    asset_subparsers = asset_parser.add_subparsers(dest="action")

    list_asset = asset_subparsers.add_parser("list", help="åˆ—å‡ºèµ„äº§")
    list_asset.add_argument("--skip", type=int, default=0, help="è·³è¿‡çš„è®°å½•æ•°")
    list_asset.add_argument("--limit", type=int, default=100, help="è¿”å›çš„æœ€å¤§è®°å½•æ•°")
    list_asset.set_defaults(func=cmd_asset_list)

    # å¸‚åœº
    market_parser = subparsers.add_parser("marketplace", help="å¸‚åœºç®¡ç†")
    market_subparsers = market_parser.add_subparsers(dest="action")

    stats = market_subparsers.add_parser("stats", help="è·å–å¸‚åœºç»Ÿè®¡")
    stats.set_defaults(func=cmd_marketplace_stats)

    # æ²»ç†
    governance_parser = subparsers.add_parser("governance", help="æ²»ç†ç®¡ç†")
    governance_subparsers = governance_parser.add_subparsers(dest="action")

    list_proposal = governance_subparsers.add_parser("list", help="åˆ—å‡ºææ¡ˆ")
    list_proposal.add_argument("--skip", type=int, default=0, help="è·³è¿‡çš„è®°å½•æ•°")
    list_proposal.add_argument("--limit", type=int, default=100, help="è¿”å›çš„æœ€å¤§è®°å½•æ•°")
    list_proposal.add_argument("--status", help="çŠ¶æ€è¿‡æ»¤")
    list_proposal.set_defaults(func=cmd_proposal_list)

    return parser


def main():
    """ä¸»å‡½æ•°"""
    parser = create_parser()
    args = parser.parse_args()

    # å¦‚æœæ²¡æœ‰å‘½ä»¤ï¼Œæ˜¾ç¤ºå¸®åŠ©
    if not args.command:
        parser.print_help()
        return

    # æ‰§è¡Œå‘½ä»¤
    if hasattr(args, "func"):
        args.func(args)
    else:
        print_error(f"æœªçŸ¥å‘½ä»¤: {args.command}")
        parser.print_help()


if __name__ == "__main__":
    main()
