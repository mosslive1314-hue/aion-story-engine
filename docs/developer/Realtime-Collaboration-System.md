# å®æ—¶åä½œç³»ç»Ÿ (Real-time Collaboration System)

## æ¦‚è¿°

å®æ—¶åä½œç³»ç»Ÿæ˜¯ AION Story Engine çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œæä¾›å®Œæ•´çš„å¤šç”¨æˆ·å®æ—¶åä½œç¼–è¾‘ä½“éªŒã€‚è¯¥ç³»ç»Ÿé›†æˆäº† WebSocket é€šä¿¡ã€åŒæ­¥å¼•æ“ã€å†²çªè§£å†³ã€åœ¨çº¿çŠ¶æ€ç®¡ç†å’Œé€šçŸ¥ç³»ç»Ÿã€‚

## ğŸ¯ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å‰ç«¯åº”ç”¨                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Realtime    â”‚  â”‚  Presence    â”‚  â”‚ Notificationsâ”‚ â”‚
â”‚  â”‚  Editor      â”‚  â”‚  API         â”‚  â”‚  Manager   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                 â”‚                 â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚                 â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              WebSocket æœåŠ¡å™¨                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Connection   â”‚  â”‚ Message      â”‚  â”‚ Broadcast  â”‚ â”‚
â”‚  â”‚ Manager     â”‚  â”‚ Router       â”‚  â”‚ Handler    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åŒæ­¥å¼•æ“ (Sync Engine)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Operation    â”‚  â”‚ Conflict     â”‚  â”‚ Version    â”‚ â”‚
â”‚  â”‚ Transform    â”‚  â”‚ Resolver     â”‚  â”‚ Vector     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                 â”‚                 â”‚          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Undo/Redo   â”‚  â”‚ Snapshot    â”‚  â”‚ Branch     â”‚ â”‚
â”‚  â”‚ Manager      â”‚  â”‚ System      â”‚  â”‚ Manager    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ æ ¸å¿ƒç»„ä»¶

### 1. WebSocket é€šä¿¡ç³»ç»Ÿ
**æ–‡ä»¶**: `aion_engine/realtime/websocket.py`

- **WebSocketManager** - è¿æ¥ç®¡ç†å™¨
- **æ¶ˆæ¯è·¯ç”±** - å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯
- **æˆ¿é—´ç®¡ç†** - å¤šç”¨æˆ·æˆ¿é—´æ”¯æŒ
- **å¹¿æ’­ç³»ç»Ÿ** - å‘ç”¨æˆ·ç»„å‘é€æ¶ˆæ¯

**åŠŸèƒ½**:
- âœ… å®æ—¶åŒå‘é€šä¿¡
- âœ… ç”¨æˆ·åŠ å…¥/ç¦»å¼€å¤„ç†
- âœ… å…‰æ ‡ä½ç½®åŒæ­¥
- âœ… é€‰æ‹©èŒƒå›´åŒæ­¥
- âœ… å¿ƒè·³æ£€æµ‹

### 2. å®æ—¶åŒæ­¥å¼•æ“
**æ–‡ä»¶**: `aion_engine/realtime/sync.py`

- **RealtimeSyncEngine** - æ ¸å¿ƒåŒæ­¥å¼•æ“
- **AdvancedConflictResolver** - é«˜çº§å†²çªè§£å†³å™¨
- **æ“ä½œå˜æ¢ (OT)** - å¹¶å‘ç¼–è¾‘å†²çªè§£å†³
- **ç‰ˆæœ¬å‘é‡** - åˆ†å¸ƒå¼ä¸€è‡´æ€§

**åŠŸèƒ½**:
- âœ… æ“ä½œå˜æ¢ (OT) ç®—æ³•
- âœ… æ’¤é”€/é‡åšç³»ç»Ÿ
- âœ… åˆ†æ”¯ç®¡ç†
- âœ… å¿«ç…§ç³»ç»Ÿ
- âœ… æ‰¹é‡æ“ä½œ
- âœ… ç‰ˆæœ¬å‘é‡

### 3. åœ¨çº¿çŠ¶æ€ç®¡ç†
**æ–‡ä»¶**: `aion_engine/realtime/presence.py`

- **PresenceManager** - åœ¨çº¿çŠ¶æ€ç®¡ç†å™¨
- **UserPresence** - ç”¨æˆ·åœ¨çº¿çŠ¶æ€
- **RoomPresence** - æˆ¿é—´åœ¨çº¿çŠ¶æ€

**åŠŸèƒ½**:
- âœ… ç”¨æˆ·åœ¨çº¿/ç¦»çº¿çŠ¶æ€
- âœ… æ´»åŠ¨ç±»å‹è¿½è¸ª
- âœ… ç»Ÿè®¡ä¿¡æ¯
- âœ… æˆ¿é—´ç®¡ç†

### 4. é€šçŸ¥ç³»ç»Ÿ
**æ–‡ä»¶**: `aion_engine/realtime/notifications.py`

- **NotificationManager** - é€šçŸ¥ç®¡ç†å™¨
- **å¤šé€šé“æ”¯æŒ** - æµè§ˆå™¨ã€é‚®ä»¶ã€åº”ç”¨å†…
- **æ¨¡æ¿ç³»ç»Ÿ** - é€šçŸ¥æ¨¡æ¿
- **ä¼˜å…ˆçº§ç®¡ç†** - é€šçŸ¥ä¼˜å…ˆçº§

**åŠŸèƒ½**:
- âœ… å¤šé€šé“é€šçŸ¥
- âœ… æ¨¡æ¿ç³»ç»Ÿ
- âœ… ä¼˜å…ˆçº§é˜Ÿåˆ—
- âœ… æ‰¹é‡å‘é€
- âœ… è¿‡æœŸæ¸…ç†

### 5. å®æ—¶åä½œç¼–è¾‘å™¨
**æ–‡ä»¶**: `frontend/components/RealtimeEditor.tsx`

- **React ç»„ä»¶** - å¯å¤ç”¨çš„ç¼–è¾‘å™¨
- **WebSocket Hook** - è¿æ¥ç®¡ç†
- **å®æ—¶å…‰æ ‡** - å¤šç”¨æˆ·å…‰æ ‡æ˜¾ç¤º
- **è§†è§‰åé¦ˆ** - ä¼˜é›…çš„ UI

**åŠŸèƒ½**:
- âœ… å®æ—¶ç¼–è¾‘
- âœ… å…‰æ ‡æ˜¾ç¤º
- âœ… ç”¨æˆ·åˆ—è¡¨
- âœ… è¿æ¥çŠ¶æ€
- âœ… å†²çªæç¤º

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å¯åŠ¨ WebSocket æœåŠ¡å™¨

```bash
cd /c/Users/maiyi/Desktop/story
python -m aion_engine.realtime.websocket
```

æœåŠ¡å™¨å°†åœ¨ `ws://localhost:8765` å¯åŠ¨ã€‚

### å¯åŠ¨å‰ç«¯åº”ç”¨

```bash
cd /c/Users/maiyi/Desktop/story/frontend
npm install
npm run dev
```

è®¿é—® `http://localhost:3000/editor` æ‰“å¼€åä½œç¼–è¾‘å™¨ã€‚

### ä½¿ç”¨æµ‹è¯•å®¢æˆ·ç«¯

```bash
# å¯åŠ¨ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯
node test_client.js ws://localhost:8765 demo-doc user1 "å¼ ä¸‰"

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯å¯åŠ¨ç¬¬äºŒä¸ªå®¢æˆ·ç«¯
node test_client.js ws://localhost:8765 demo-doc user2 "æå››"
```

## ğŸ“š API å‚è€ƒ

### WebSocket æ¶ˆæ¯ç±»å‹

```typescript
enum MessageType {
  JOIN = 'join',          // åŠ å…¥æˆ¿é—´
  LEAVE = 'leave',        // ç¦»å¼€æˆ¿é—´
  UPDATE = 'update',      // æ›´æ–°
  CURSOR = 'cursor',      // å…‰æ ‡ä½ç½®
  SELECTION = 'selection',  // é€‰æ‹©èŒƒå›´
  CHANGE = 'change',      // å†…å®¹å˜æ›´
  PING = 'ping',          // å¿ƒè·³
  PONG = 'pong',          // å¿ƒè·³å›å¤
  ERROR = 'error',        // é”™è¯¯
  PRESENCE = 'presence',   // åœ¨çº¿çŠ¶æ€
  SYNC = 'sync'           // åŒæ­¥
}
```

### æ¶ˆæ¯æ ¼å¼

```typescript
interface WebSocketMessage {
  type: MessageType;
  room_id: string;
  user_id: string;
  data: any;
  timestamp: Date;
}
```

### æ“ä½œæ ¼å¼

```typescript
interface Operation {
  id: string;
  type: 'insert' | 'delete' | 'update';
  position: number;
  user_id: string;
  content?: string;
  length: number;
  timestamp: Date;
  version: number;
  branch_id?: string;
  base_version?: number;
  undo_of?: string;
  redo_of?: string;
  metadata?: Record<string, any>;
}
```

## ğŸ§ª æµ‹è¯•

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
python -m pytest tests/test_realtime.py -v
```

### æµ‹è¯•è¦†ç›–ç‡

```bash
python -m pytest tests/test_realtime.py --cov=aion_engine.realtime --cov-report=html
```

### æµ‹è¯•å®¢æˆ·ç«¯

```bash
# åŸºæœ¬æµ‹è¯•
node test_client.js ws://localhost:8765 test-doc user1 "æµ‹è¯•ç”¨æˆ·"

# å‹åŠ›æµ‹è¯•
for i in {1..5}; do
  node test_client.js ws://localhost:8765 stress-test user$i "ç”¨æˆ·$i" &
done
```

## ğŸ”§ é…ç½®

### WebSocket æœåŠ¡å™¨é…ç½®

```python
# aion_engine/realtime/websocket.py
async def start_websocket_server(
    host: str = "0.0.0.0",  # ç›‘å¬åœ°å€
    port: int = 8765         # ç›‘å¬ç«¯å£
):
    # æœåŠ¡å™¨é…ç½®
    pass
```

### ç¼–è¾‘å™¨é…ç½®

```typescript
// frontend/components/RealtimeEditor.tsx
interface RealtimeEditorProps {
  documentId: string;      // æ–‡æ¡£ ID
  userId: string;         // ç”¨æˆ· ID
  username: string;        // ç”¨æˆ·å
  websocketUrl?: string;   // WebSocket URL (é»˜è®¤: ws://localhost:8765)
  initialContent?: string;  // åˆå§‹å†…å®¹
}
```

## ğŸ¨ æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„æ¶ˆæ¯ç±»å‹

1. **å®šä¹‰ç±»å‹**
```typescript
// frontend/components/types/realtime.ts
export enum MessageType {
  // ç°æœ‰ç±»å‹...
  NEW_TYPE = 'new_type'
}
```

2. **å¤„ç†æ¶ˆæ¯**
```typescript
// frontend/components/useWebSocket.ts
case MessageType.NEW_TYPE:
  // å¤„ç†é€»è¾‘
  break;
```

3. **æ›´æ–°æœåŠ¡å™¨**
```python
# aion_engine/realtime/websocket.py
class MessageType(Enum):
    # ç°æœ‰ç±»å‹...
    NEW_TYPE = "new_type"
```

### æ·»åŠ æ–°çš„å†²çªè§£å†³ç®—æ³•

```python
# aion_engine/realtime/sync.py
class AdvancedConflictResolver:
    @staticmethod
    def transform_custom(op1: Operation, op2: Operation) -> Tuple[Operation, Operation]:
        # å®ç°è‡ªå®šä¹‰å˜æ¢ç®—æ³•
        return op1, op2
```

### æ·»åŠ æ–°çš„é€šçŸ¥é€šé“

```python
# aion_engine/realtime/notifications.py
class SlackNotificationChannel(NotificationChannel):
    def send(self, notification: Notification) -> bool:
        # å®ç° Slack é€šçŸ¥
        return True
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### å»¶è¿Ÿç›®æ ‡
- **æ“ä½œä¼ æ’­å»¶è¿Ÿ**: < 50ms
- **å†²çªè§£å†³å»¶è¿Ÿ**: < 100ms
- **WebSocket é‡è¿æ—¶é—´**: < 3s

### å¹¶å‘èƒ½åŠ›
- **å•æˆ¿é—´æœ€å¤§ç”¨æˆ·**: 100+
- **å¹¶å‘æˆ¿é—´æ•°**: 1000+
- **æ“ä½œååé‡**: 10,000 ops/sec

### èµ„æºä½¿ç”¨
- **å†…å­˜ä½¿ç”¨**: ~10MB/1000 ç”¨æˆ·
- **CPU ä½¿ç”¨**: < 5% (æ­£å¸¸è´Ÿè½½)
- **å¸¦å®½**: ~1KB/ç”¨æˆ·/æ“ä½œ

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**1. WebSocket è¿æ¥å¤±è´¥**
```bash
# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
netstat -an | grep 8765

# å¯åŠ¨æœåŠ¡å™¨
python -m aion_engine.realtime.websocket
```

**2. æ“ä½œä¸åŒæ­¥**
- æ£€æŸ¥ç‰ˆæœ¬å‘é‡æ˜¯å¦æ­£ç¡®
- éªŒè¯æ“ä½œå˜æ¢é€»è¾‘
- æŸ¥çœ‹å†²çªè§£å†³æ—¥å¿—

**3. å†…å­˜æ³„æ¼**
- æ£€æŸ¥æ’¤é”€æ ˆå¤§å°é™åˆ¶
- éªŒè¯å¿«ç…§æ¸…ç†
- ç›‘æ§ç”¨æˆ·è¿æ¥çŠ¶æ€

### è°ƒè¯•æ¨¡å¼

```python
# å¯ç”¨è¯¦ç»†æ—¥å¿—
import logging
logging.basicConfig(level=logging.DEBUG)
```

## ğŸ“ˆ ç›‘æ§

### å…³é”®æŒ‡æ ‡
- è¿æ¥æ•°
- æ´»è·ƒæˆ¿é—´æ•°
- æ“ä½œå»¶è¿Ÿ
- å†²çªç‡
- é”™è¯¯ç‡

### å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥ WebSocket æœåŠ¡å™¨
curl http://localhost:8765/health

# æ£€æŸ¥æ‰€æœ‰æœåŠ¡
python -m pytest tests/test_realtime.py -v
```

## ğŸ¤ è´¡çŒ®

æ¬¢è¿è´¡çŒ®ä»£ç ï¼è¯·éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯ Pull Request

### å¼€å‘æŒ‡å—
- éµå¾ª PEP 8 (Python)
- éµå¾ª TypeScript æœ€ä½³å®è·µ
- æ·»åŠ å•å…ƒæµ‹è¯•
- æ›´æ–°æ–‡æ¡£

## ğŸ“„ è®¸å¯è¯

MIT License - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

## ğŸ™ è‡´è°¢

- WebSocket åè®®
- Operational Transform ç®—æ³•
- React Hooks æ¨¡å¼
- Next.js æ¡†æ¶

## ğŸ“ è”ç³»æˆ‘ä»¬

- é¡¹ç›®ä¸»é¡µ: https://github.com/aion/story-engine
- é—®é¢˜åé¦ˆ: https://github.com/aion/story-engine/issues
- è®¨è®ºåŒº: https://github.com/aion/story-engine/discussions

---

**AION Story Engine** - Phase 6.2 å®æ—¶åä½œç³»ç»Ÿ Â© 2026
